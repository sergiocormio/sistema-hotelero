<?xml version="1.0" encoding="utf-8"?>
<!-- http://blog.flexexamples.com/2009/07/25/exporting-a-textflow-object-in-flex-4/ -->
<s:Panel name="CustomEditor"
		 xmlns:fx="http://ns.adobe.com/mxml/2009"
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 width="100%" height="100%">
	<s:layout>
		<s:VerticalLayout gap="0" />
	</s:layout>
	
	<fx:Script>
		<![CDATA[
			import flash.text.engine.FontPosture;
			import flash.text.engine.FontWeight;
			import flash.text.engine.TextElement;
			
			import flashx.textLayout.conversion.ConversionType;
			import flashx.textLayout.conversion.TextConverter;
			import flashx.textLayout.elements.LinkElement;
			import flashx.textLayout.elements.ParagraphElement;
			import flashx.textLayout.formats.TextAlign;
			import flashx.textLayout.formats.TextDecoration;
			import flashx.textLayout.formats.TextLayoutFormat;
			
			import model.Url;
			
			import mx.containers.TitleWindow;
			import mx.events.ColorPickerEvent;
			import mx.events.FlexEvent;
			
			import resources.icons.Icons;
			
			import spark.events.IndexChangeEvent;
			
			import utils.WindowsUtils;
			import mx.managers.PopUpManager;
			
			import view.forms.UrlForm;
			
			
			[Bindable]
			public var loc:Object;
			
			private var titleWindow:TitleWindow;
			private var urlForm:UrlForm;
			
			
			
			protected function editor_selectionChangeHandler(evt:FlexEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				fontDDL.selectedItem = txtLayFmt.fontFamily;
				sizeDDL.selectedItem = txtLayFmt.fontSize;
				boldBtn.selected = (txtLayFmt.fontWeight == FontWeight.BOLD);
				italBtn.selected = (txtLayFmt.fontStyle == FontPosture.ITALIC);
				underBtn.selected = (txtLayFmt.textDecoration == TextDecoration.UNDERLINE);
				colorCP.selectedColor = txtLayFmt.color;
				lineBtn.selected = txtLayFmt.lineThrough;
				
				switch (txtLayFmt.textAlign) {
					case TextAlign.LEFT:
						txtAlignBB.selectedIndex = 0;
						break;
					case TextAlign.CENTER:
						txtAlignBB.selectedIndex = 1;
						break;
					case TextAlign.RIGHT:
						txtAlignBB.selectedIndex = 2;
						break;
					case TextAlign.JUSTIFY:
						txtAlignBB.selectedIndex = 3;
						break;
					default:
						txtAlignBB.selectedIndex = -1;
						break;
				}
			}
			
			protected function fontDDL_changeHandler(evt:IndexChangeEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.fontFamily = fontDDL.selectedItem;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			protected function sizeDDL_changeHandler(evt:IndexChangeEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.fontSize = sizeDDL.selectedItem;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			protected function boldBtn_clickHandler(evt:MouseEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.fontWeight = (txtLayFmt.fontWeight == FontWeight.BOLD) ? FontWeight.NORMAL : FontWeight.BOLD;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			protected function italBtn_clickHandler(evt:MouseEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.fontStyle = (txtLayFmt.fontStyle == FontPosture.ITALIC) ? FontPosture.NORMAL : FontPosture.ITALIC;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			protected function underBtn_clickHandler(evt:MouseEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.textDecoration = (txtLayFmt.fontStyle == TextDecoration.UNDERLINE) ? TextDecoration.NONE : TextDecoration.UNDERLINE;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			protected function colorCP_changeHandler(evt:ColorPickerEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.color = colorCP.selectedColor;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			protected function txtAlignBB_changeHandler(evt:IndexChangeEvent):void {
				if (txtAlignBB.selectedItem) {
					var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
						editor.selectionAnchorPosition,
						editor.selectionActivePosition);
					txtLayFmt.textAlign = txtAlignBB.selectedItem.value;
					editor.setFormatOfRange(txtLayFmt,
						editor.selectionAnchorPosition,
						editor.selectionActivePosition);
					editor.setFocus();
				}
			}
			
			protected function lineBtn_clickHandler(evt:MouseEvent):void {
				var txtLayFmt:TextLayoutFormat = editor.getFormatOfRange(null,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				txtLayFmt.lineThrough = lineBtn.selected;
				editor.setFormatOfRange(txtLayFmt,
					editor.selectionAnchorPosition,
					editor.selectionActivePosition);
				editor.setFocus();
			}
			
			
			
			private function openUrlForm():void{
				urlForm = new UrlForm();
				urlForm.loc = loc;
				urlForm.addEventListener("saveSuccess",url_saveSuccess);
				urlForm.addEventListener("cancelClicked",titleWindow_close);
				titleWindow = WindowsUtils.openDialog(loc.button.addUrl, urlForm, this.owner);
			}
			
			
			protected function url_saveSuccess(evt:Object):void {
				
				var url:Url = urlForm.currentUrl;
				 
				if(url.value != "" && url.value != urlForm.defaultLinkProtocol){
					
					var link:String = "<a href=\"" + url.value + "\">" + url.label + "</a>";
					
					editor.textFlow.addChild(TextConverter.importToFlow(link, TextConverter.TEXT_FIELD_HTML_FORMAT).getChildAt(0));
					editor.textFlow.flowComposer.updateAllControllers();
				}
				
				PopUpManager.removePopUp(titleWindow);
			}
			
			private function titleWindow_close(evt:Object):void {
				PopUpManager.removePopUp(titleWindow);
			}
			
		]]>
	</fx:Script>
	
	<s:TextArea id="editor"
				focusEnabled="false"
				width="100%" height="95%"
				selectionChange="editor_selectionChangeHandler(event);">
		<s:textFlow>
			<s:TextFlow id="_tf">
			</s:TextFlow>
		</s:textFlow>
	</s:TextArea>
	<mx:ControlBar width="100%" height="5%" cornerRadius="0">
		<mx:ToolBar width="100%" horizontalGap="5">
			<s:DropDownList id="fontDDL"
							width="150"
							selectedIndex="0"
							change="fontDDL_changeHandler(event);">
				<s:dataProvider>
					<s:ArrayList source="[Arial,Courier,Courier New,Geneva,Georgia,Helvetica,Times New Roman,Trebuchet MS,Verdana]" />
				</s:dataProvider>
			</s:DropDownList>
			<s:DropDownList id="sizeDDL"
							width="60"
							selectedIndex="4"
							change="sizeDDL_changeHandler(event);">
				<s:dataProvider>
					<s:ArrayList source="[8,9,10,11,12,14,16,18,20,24,26,28,36,48,72]" />
				</s:dataProvider>
			</s:DropDownList>
			<s:ToggleButton id="boldBtn"
							label="B"
							fontWeight="bold"
							width="30"
							click="boldBtn_clickHandler(event);" />
			<s:ToggleButton id="italBtn"
							label="I"
							fontStyle="italic"
							width="30"
							click="italBtn_clickHandler(event);" />
			<s:ToggleButton id="underBtn"
							label="U" 
							textDecoration="underline"
							width="30"
							click="underBtn_clickHandler(event);" />
			<s:ToggleButton id="lineBtn"
							label="S"
							lineThrough="true"
							width="30"
							click="lineBtn_clickHandler(event);" />
			<mx:ColorPicker id="colorCP"
							change="colorCP_changeHandler(event);" />
			<s:ButtonBar id="txtAlignBB"
						 arrowKeysWrapFocus="true"
						 labelField="label"
						 width="120"
						 change="txtAlignBB_changeHandler(event);">
				<s:dataProvider>
					<s:ArrayList>
						<fx:Object icon="{Icons.alignLeft}" value="{TextAlign.LEFT}" />
						<fx:Object icon="{Icons.alignCenter}" value="{TextAlign.CENTER}" />
						<fx:Object icon="{Icons.alignRight}" value="{TextAlign.RIGHT}" />
						<fx:Object icon="{Icons.alignJustify}" value="{TextAlign.JUSTIFY}" />
					</s:ArrayList>
				</s:dataProvider>
			</s:ButtonBar>
						
			<s:Button width="30" click="openUrlForm();"
					  icon="{Icons.addLink}" toolTip="{loc.button.addLink}"/>
		</mx:ToolBar>
	</mx:ControlBar>
	
</s:Panel>